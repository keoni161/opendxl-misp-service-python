
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Basic Event Notification Example &#8212; MISP DXL Python Service 0.1.1 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="dxlmispservice package" href="dxlmispservice.html" />
    <link rel="prev" title="Basic Update Event Example" href="basicupdateeventexample.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="dxlmispservice.html" title="dxlmispservice package"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="basicupdateeventexample.html" title="Basic Update Event Example"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">MISP DXL Python Service 0.1.1 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="basic-event-notification-example">
<h1>Basic Event Notification Example<a class="headerlink" href="#basic-event-notification-example" title="Permalink to this headline">¶</a></h1>
<p>This sample registers a callback to receive event notifications from the DXL
fabric when new MISP events are created. The sample creates a new event on a
MISP server via the MISP <code class="docutils literal notranslate"><span class="pre">Events</span></code> API. The sample waits for a corresponding
event notification from the DXL fabric via the MISP ZeroMQ plugin. The sample
displays the contents of the payload from the event notification that it
receives.</p>
<p>For more information on the MISP <code class="docutils literal notranslate"><span class="pre">Events</span></code> API, see the
<a class="reference external" href="https://media.readthedocs.org/pdf/pymisp/master/pymisp.pdf">PyMISP new_event API</a>
and <a class="reference external" href="https://misp.gitbooks.io/misp-book/content/automation/#post-events">MISP Event API</a>
documentation. For more information on the ZeroMQ plugin, see the documentation
for the
<a class="reference external" href="https://misp.gitbooks.io/misp-book/misp-zmq/#misp-zeromq-configuration">MISP ZeroMQ plugin</a>.</p>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">The samples configuration step has been completed (see <a class="reference internal" href="sampleconfig.html"><span class="doc">Samples Configuration</span></a>).</p>
</li>
<li><p class="first">The MISP DXL Python Service is running, using the <code class="docutils literal notranslate"><span class="pre">sample</span></code> configuration
(see <a class="reference internal" href="running.html"><span class="doc">Running</span></a>).</p>
</li>
<li><p class="first">Enable the MISP ZeroMQ plugin and ZeroMQ event notifications.</p>
<p>From the MISP web server UI, do the following:</p>
<ul class="simple">
<li>Navigate to the <code class="docutils literal notranslate"><span class="pre">Server</span> <span class="pre">Settings</span> <span class="pre">&amp;</span> <span class="pre">Maintenance</span></code> page under the
<code class="docutils literal notranslate"><span class="pre">Administration</span></code> menu.</li>
<li>Select the <code class="docutils literal notranslate"><span class="pre">Plugin</span> <span class="pre">Settings</span></code> tab.</li>
<li>Expand the <code class="docutils literal notranslate"><span class="pre">ZeroMQ</span></code> option in the plugin list.</li>
<li>Set the <code class="docutils literal notranslate"><span class="pre">Plugin.ZeroMQ_enable</span></code> setting to <code class="docutils literal notranslate"><span class="pre">true</span></code>.</li>
<li>Set the <code class="docutils literal notranslate"><span class="pre">Plugin.ZeroMQ_event_notification_enable</span></code> setting to <code class="docutils literal notranslate"><span class="pre">true</span></code>.</li>
</ul>
<p>This step is needed to enable the DXL MISP service to be able to receive event
notification messages from the MISP ZeroMQ server. For more information, see
the documentation for the
<a class="reference external" href="https://misp.gitbooks.io/misp-book/misp-zmq/#misp-zeromq-configuration">MISP ZeroMQ configuration</a>.</p>
</li>
</ul>
</div>
<div class="section" id="running">
<h2>Running<a class="headerlink" href="#running" title="Permalink to this headline">¶</a></h2>
<p>To run this sample execute the <code class="docutils literal notranslate"><span class="pre">sample/basic/basic_event_notification.py</span></code>
script as follows:</p>
<blockquote>
<div><div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python sample/basic/basic_event_notification.py
</pre></div>
</div>
</div></blockquote>
<p>The output should appear similar to the following:</p>
<blockquote>
<div><div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>Create new MISP event and <span class="nb">wait</span> <span class="k">for</span> notification via ZeroMQ ...
Received event:
<span class="o">{</span>
    <span class="s2">&quot;Event&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;analysis&quot;</span>: <span class="s2">&quot;1&quot;</span>,
        <span class="s2">&quot;attribute_count&quot;</span>: <span class="s2">&quot;0&quot;</span>,
        <span class="s2">&quot;date&quot;</span>: <span class="s2">&quot;2018-04-09&quot;</span>,
        <span class="s2">&quot;disable_correlation&quot;</span>: false,
        <span class="s2">&quot;distribution&quot;</span>: <span class="s2">&quot;3&quot;</span>,
        <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;172&quot;</span>,
        <span class="s2">&quot;info&quot;</span>: <span class="s2">&quot;OpenDXL MISP event notification example&quot;</span>,
        <span class="s2">&quot;locked&quot;</span>: false,
        <span class="s2">&quot;org_id&quot;</span>: <span class="s2">&quot;1&quot;</span>,
        <span class="s2">&quot;orgc_id&quot;</span>: <span class="s2">&quot;1&quot;</span>,
        <span class="s2">&quot;proposal_email_lock&quot;</span>: false,
        <span class="s2">&quot;publish_timestamp&quot;</span>: <span class="s2">&quot;0&quot;</span>,
        <span class="s2">&quot;published&quot;</span>: false,
        <span class="s2">&quot;sharing_group_id&quot;</span>: <span class="s2">&quot;0&quot;</span>,
        <span class="s2">&quot;threat_level_id&quot;</span>: <span class="s2">&quot;3&quot;</span>,
        <span class="s2">&quot;timestamp&quot;</span>: <span class="s2">&quot;1523288047&quot;</span>,
        <span class="s2">&quot;user_id&quot;</span>: <span class="s2">&quot;1&quot;</span>,
        <span class="s2">&quot;uuid&quot;</span>: <span class="s2">&quot;5acb87ef-8c9c-4347-b0c1-196cac110002&quot;</span>
    <span class="o">}</span>,
    <span class="s2">&quot;EventTag&quot;</span>: <span class="o">[]</span>,
    <span class="s2">&quot;Orgc&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;1&quot;</span>,
        <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;ORGNAME&quot;</span>,
        <span class="s2">&quot;uuid&quot;</span>: <span class="s2">&quot;5ac3c55a-41a4-4294-adf3-00f8ac110003&quot;</span>
    <span class="o">}</span>,
    <span class="s2">&quot;action&quot;</span>: <span class="s2">&quot;add&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="details">
<h2>Details<a class="headerlink" href="#details" title="Permalink to this headline">¶</a></h2>
<p>In order to enable the use of the <code class="docutils literal notranslate"><span class="pre">new_event</span></code> API, the <code class="docutils literal notranslate"><span class="pre">new_event</span></code> API
names is listed in the <code class="docutils literal notranslate"><span class="pre">apiNames</span></code> setting under the <code class="docutils literal notranslate"><span class="pre">[General]</span></code> section in
the <code class="docutils literal notranslate"><span class="pre">sample</span></code> &quot;dxlmispservice.config&quot; file that the service uses:</p>
<blockquote>
<div><div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[General]</span>
<span class="na">apiNames</span><span class="o">=</span><span class="s">new_event,...</span>
</pre></div>
</div>
</div></blockquote>
<p>For more information on the configuration, see the
<a class="reference internal" href="configuration.html#dxl-service-config-file-label"><span class="std std-ref">Service Configuration File</span></a> section.</p>
<p>The code for the sample is broken into two main sections.</p>
<p>The first section is responsible for registering a callback to receive
notifications for <code class="docutils literal notranslate"><span class="pre">misp_json_event</span></code> MISP ZeroMQ notifications:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">EVENT_TOPIC</span> <span class="o">=</span> <span class="s2">&quot;/opendxl-misp/event/zeromq-notifications/misp_json_event&quot;</span>

<span class="o">...</span>

<span class="c1"># Create the client</span>
<span class="k">with</span> <span class="n">DxlClient</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>

    <span class="c1"># Connect to the fabric</span>
    <span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connected to DXL fabric.&quot;</span><span class="p">)</span>

    <span class="c1"># Create and add event listener</span>
    <span class="k">class</span> <span class="nc">MyEventCallback</span><span class="p">(</span><span class="n">EventCallback</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">on_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
            <span class="n">event_payload_dict</span> <span class="o">=</span> <span class="n">MessageUtils</span><span class="o">.</span><span class="n">json_payload_to_dict</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="c1"># Check the event payload to see if the OpenDXL event was triggered</span>
            <span class="c1"># by the new MISP event that the sample created.</span>
            <span class="k">if</span> <span class="s2">&quot;Event&quot;</span> <span class="ow">in</span> <span class="n">event_payload_dict</span> <span class="ow">and</span> \
                <span class="s2">&quot;info&quot;</span> <span class="ow">in</span> <span class="n">event_payload_dict</span><span class="p">[</span><span class="s2">&quot;Event&quot;</span><span class="p">]</span> <span class="ow">and</span> \
                <span class="n">event_payload_dict</span><span class="p">[</span><span class="s2">&quot;Event&quot;</span><span class="p">][</span><span class="s2">&quot;info&quot;</span><span class="p">]</span> <span class="o">==</span> \
                    <span class="s2">&quot;OpenDXL MISP event notification example&quot;</span><span class="p">:</span>
                <span class="c1"># Print the payload for the received event</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Received event:</span><span class="se">\n</span><span class="s2">{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">MessageUtils</span><span class="o">.</span><span class="n">dict_to_json</span><span class="p">(</span><span class="n">event_payload_dict</span><span class="p">,</span>
                                              <span class="n">pretty_print</span><span class="o">=</span><span class="bp">True</span><span class="p">)))</span>

    <span class="c1"># Register the callback with the client</span>
    <span class="n">client</span><span class="o">.</span><span class="n">add_event_callback</span><span class="p">(</span><span class="n">EVENT_TOPIC</span><span class="p">,</span> <span class="n">MyEventCallback</span><span class="p">())</span>
</pre></div>
</div>
</div></blockquote>
<p>When a notification is received, the contents of the event are displayed.</p>
<p>The second section is responsible for creating the MISP event which triggers the
MISP ZeroMQ event notification.</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create the new event request</span>
<span class="n">request_topic</span> <span class="o">=</span> <span class="s2">&quot;/opendxl-misp/service/misp-api/new_event&quot;</span>
<span class="n">new_event_request</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">request_topic</span><span class="p">)</span>

<span class="c1"># Set the payload for the new event request</span>
<span class="n">MessageUtils</span><span class="o">.</span><span class="n">dict_to_json_payload</span><span class="p">(</span><span class="n">new_event_request</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;distribution&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="s2">&quot;OpenDXL MISP event notification example&quot;</span><span class="p">,</span>
    <span class="s2">&quot;analysis&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;threat_level_id&quot;</span><span class="p">:</span> <span class="mi">3</span>
<span class="p">})</span>

<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Create new MISP event and wait for notification via ZeroMQ ...&quot;</span><span class="p">)</span>

<span class="c1"># Send the new event request</span>
<span class="n">new_event_response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">sync_request</span><span class="p">(</span><span class="n">new_event_request</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

<span class="k">if</span> <span class="n">new_event_response</span><span class="o">.</span><span class="n">message_type</span> <span class="o">==</span> <span class="n">Message</span><span class="o">.</span><span class="n">MESSAGE_TYPE_ERROR</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Error invoking service with topic &#39;{}&#39;: {} ({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">request_topic</span><span class="p">,</span> <span class="n">new_event_response</span><span class="o">.</span><span class="n">error_message</span><span class="p">,</span>
        <span class="n">new_event_response</span><span class="o">.</span><span class="n">error_code</span><span class="p">))</span>
    <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Wait a few seconds for the new MISP event notification to be delivered</span>
<span class="c1"># to the DXL fabric</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>After connecting to the DXL fabric, a request message is created with a topic
that targets the &quot;new_event&quot; method of the MISP DXL Python Service.</p>
<p>The next step is to set the <code class="docutils literal notranslate"><span class="pre">payload</span></code> of the request message. The contents of
the payload include information to store in the MISP event.</p>
<p>The next step is to perform a synchronous request via the DXL fabric. The
presence of the new MISP event on the server should trigger the receipt of
the event notification above.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Basic Event Notification Example</a><ul>
<li><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li><a class="reference internal" href="#running">Running</a></li>
<li><a class="reference internal" href="#details">Details</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="basicupdateeventexample.html"
                        title="previous chapter">Basic Update Event Example</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="dxlmispservice.html"
                        title="next chapter">dxlmispservice package</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/basiceventnotificationexample.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="dxlmispservice.html" title="dxlmispservice package"
             >next</a> |</li>
        <li class="right" >
          <a href="basicupdateeventexample.html" title="Basic Update Event Example"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">MISP DXL Python Service 0.1.1 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, McAfee LLC.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1.
    </div>
  </body>
</html>